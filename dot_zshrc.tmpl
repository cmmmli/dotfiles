eval "$(sheldon source)"

if [ -e $(brew --prefix)/share/zsh-completions ]; then
  FPATH=$(brew --prefix)/share/zsh-completions:$FPATH
fi
source {{ .chezmoi.homeDir }}/.config/zsh/zshrc_useful.sh

########################################
# 環境変数
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
export EDITOR=vim
export PAGER=less
export HOMEBREW_CASK_OPTS="--appdir=/Applications"

# Go
export GOPATH="$HOME/dev"
export GOROOT="$(go env GOROOT)"

# Version managers
export VOLTA_HOME="$HOME/.volta"
export PYENV_ROOT="$HOME/.pyenv"
export PGDATA='/usr/local/var/postgres'

# aqua
export AQUA_GLOBAL_CONFIG=$HOME/.config/aqua.yaml
export AQUA_PROGRESS_BAR=true

########################################
# PATH 設定 (typeset -U で重複排除)
typeset -U path PATH
path=(
    # 優先度高: ユーザーツール
    $HOME/.local/bin(N-/)
    $HOME/bin(N-/)
    $HOME/.yarn/bin(N-/)

    # Version managers
    $VOLTA_HOME/bin(N-/)
    $PYENV_ROOT/bin(N-/)
    $PYENV_ROOT/shims(N-/)
    $HOME/.rbenv/shims(N-/)
    $(aqua root-dir)/bin(N-/)

    # Kubernetes
    ${KREW_ROOT:-$HOME/.krew}/bin(N-/)

    # Go
    /usr/local/go/bin(N-/)
    $GOPATH/bin(N-/)

    # Homebrew (ARM Mac)
    /opt/homebrew/bin(N-/)
    /opt/homebrew/opt/postgresql@15/bin(N-/)
    /opt/homebrew/opt/libpq/bin(N-/)
    /opt/homebrew/opt/curl/bin(N-/)
    /opt/homebrew/opt/openssl@3/bin(N-/)
    /opt/homebrew/opt/icu4c/bin(N-/)
    /opt/homebrew/opt/pnpm/bin(N-/)

    # Homebrew (Intel Mac - legacy)
    /usr/local/bin(N-/)
    /usr/local/sbin(N-/)
    /usr/local/opt/libxml2/bin(N-/)
    /usr/local/opt/libxslt/bin(N-/)
    /usr/local/opt/libiconv/bin(N-/)
    /usr/local/opt/curl/bin(N-/)
    /usr/local/opt/openssl/bin(N-/)
    /usr/local/opt/krb5/bin(N-/)
    /usr/local/opt/krb5/sbin(N-/)
    /usr/local/aws/bin(N-/)

    # Applications
    /Applications/Alacritty.app/Contents/MacOS(N-/)

    # System
    $path
)

########################################
# rbenv: 遅延初期化 (初回呼び出し時にフル初期化)
if (( $+commands[rbenv] )); then
  rbenv() {
    unfunction rbenv
    eval "$(command rbenv init -)"
    rbenv "$@"
  }
fi

# eval "$(zellij setup --generate-auto-start zsh)"

setopt magic_equal_subst

## zshの設定
setopt auto_param_keys
# 補完候補に色つける
zstyle ':completion:*' list-colors "${LS_COLORS}"

zmodload zsh/datetime
reset_tmout() { TMOUT=$[60-EPOCHESECONDS%60] }
precmd_functions+=($precmd_fuctions reset_tmout)
redraw_tmout()  { zle reset-prompt; reset_tmout }
TRAPALRM() { redraw_tmout }

preexec() {
#   if overridden; then return; fi
   printf "\033]0;%s\a" "${1%% *} | $cwd"
}

# config peco
bindkey '^]' peco-src

function peco-src() {
  local src=$(ghq list --full-path | peco --query "$LBUFFER")
  if [ -n "$src" ]; then
    BUFFER="cd $src"
    zle accept-line
  fi
  zle -R -c
}

zle -N peco-src

# Completion設定
# キャッシュファイルは ~/.zfunc/ に格納 (generate-completions.sh で生成)
fpath=(~/.zfunc $fpath)

# compinit を1日1回だけ再生成
autoload -Uz compinit
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C
fi
autoload -U +X bashcompinit && bashcompinit

# pyenv: 遅延初期化 (初回呼び出し時にフル初期化)
# PATH は上部で設定済み
if (( $+commands[pyenv] )); then
  pyenv() {
    unfunction pyenv
    eval "$(command pyenv init -)"
    pyenv "$@"
  }
fi

export USE_GKE_GCLOUD_AUTH_PLUGIN=True

# tabtab source for packages
# uninstall by removing these lines
[[ -f ~/.config/tabtab/zsh/__tabtab.zsh ]] && . ~/.config/tabtab/zsh/__tabtab.zsh || true


export VOLTA_FEATURE_PNPM=1

# pnpm
export PNPM_HOME="{{ .chezmoi.homeDir }}/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

if [[ -x `which colordiff` ]]; then
  alias diff='colordiff -u'
else
  alias diff='diff -u'
fi

eval "$(starship init zsh)"

### MANAGED BY RANCHER DESKTOP START (DO NOT EDIT)
export PATH="{{ .chezmoi.homeDir }}/.rd/bin:$PATH"
### MANAGED BY RANCHER DESKTOP END (DO NOT EDIT)

alias beep='for i in {1..3}; do afplay /System/Library/Sounds/Morse.aiff; done'

# The next line updates PATH for the Google Cloud SDK.
if [ -f '{{ .chezmoi.homeDir }}/google-cloud-sdk/path.zsh.inc' ]; then . '{{ .chezmoi.homeDir }}/google-cloud-sdk/path.zsh.inc'; fi

# The next line enables shell command completion for gcloud.
if [ -f '{{ .chezmoi.homeDir }}/google-cloud-sdk/completion.zsh.inc' ]; then . '{{ .chezmoi.homeDir }}/google-cloud-sdk/completion.zsh.inc'; fi

alias gwt='cd "$(git worktree list | peco | awk "{print \$1}")"'
eval "$(mise activate zsh)"

complete -o nospace -C {{ .chezmoi.homeDir }}/.local/share/aquaproj-aqua/pkgs/http/releases.hashicorp.com/terraform/1.7.5/terraform_1.7.5_darwin_arm64.zip/terraform terraform

tre() { command tre "$@" -e vim && source "/tmp/tre_aliases_$USER" 2>/dev/null; }

# Added by Antigravity
export PATH="{{ .chezmoi.homeDir }}/.antigravity/antigravity/bin:$PATH"
